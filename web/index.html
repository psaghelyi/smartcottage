<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@^3"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@^2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@^1"></script>
  <title>Smart Cottage</title>
</head>

<body>
  <h1>Temperature ˚C</h1>
  <div class="container">
    <canvas id="temperatureChart"></canvas>
  </div>
  <h1>Relative Humidity %</h1>
  <div class="container">
    <canvas id="humidityChart"></canvas>
  </div>

  <script>
    var sensorData = { s1: [], s3: [], s4: [], mk1: [], mk2: [], s6: [] }

    function epoch2time(epoch) {
      const myDate = new Date(epoch * 1000);
      //return myDate.toLocaleString('hu-HU');
      return myDate.toISOString()
    };

    async function retrieveSensorDatas()
    {
      await Promise.allSettled([
        getSensorData("s1", sensorData),
        getSensorData("s3", sensorData),
        getSensorData("s4", sensorData),
        getSensorData("mk1", sensorData),
        getSensorData("mk2", sensorData),
        getSensorData("s6", sensorData)        
      ])
    }

    function drawChart(chartName, dataField) {      
      const ctxTemperature = document.getElementById(chartName).getContext('2d');
      const chart = new Chart(ctxTemperature,
        {
          type: 'line',
          data: {
            datasets: [
              {
                label: 'Györök-fent',
                data: sensorData.s1,
                borderColor: 'DeepSkyBlue',
                backgroundColor: 'Navy',
                pointRadius: 1
              },
              {
                label: 'Györök-lent',
                data: sensorData.s4,
                borderColor: '#B2BEB5',
                backgroundColor: '#708090',
                pointRadius: 1
              },
              {
                label: 'Györök-kint',
                data: sensorData.s3,
                borderColor: 'Lime',
                backgroundColor: 'DarkGreen',
                pointRadius: 1,
              },
              {
                label: 'Kovi-bent',
                data: sensorData.mk1,
                borderColor: 'SandyBrown',
                backgroundColor: 'Maroon',
                pointRadius: 1
              },
              {
                label: 'Kovi-kint',
                data: sensorData.mk2,
                borderColor: 'Gold',
                backgroundColor: 'DarkOrange',
                pointRadius: 1
              },
              {
                label: 'Galgó',
                data: sensorData.s6,
                borderColor: '#A020F0',
                backgroundColor: '#6C3082',
                pointRadius: 1
              }
            ]
          },
          options: {
            parsing: {
              xAxisKey: 'dt',
              yAxisKey: 'data.' + dataField
            },
            plugins: {
              tooltip: {
                //enabled: false
              },
            },
            scales: {
              x: {
                type: 'time',
                time: {
                  unit: 'hour',
                  tooltipFormat: 'yyyy.MM.dd HH:mm',
                  displayFormats: {
                    hour: 'MMM dd. HH:mm'
                  }
                },
                title: {
                  display: false
                }
              }
            }
          }
        });
    };

    retrieveSensorDatas().then(_ => {
      drawChart('temperatureChart', 'temperature');
      drawChart('humidityChart', 'humidity');
    })

    //Fetch Data from API
    async function getSensorData(id, storage) {
      const apiUrl = window.location.origin + "/sensor/" + id
      console.log(apiUrl)
      const response = await fetch(apiUrl)
      const result = await response.json()
      storage[id] = result.map((x) => { return { dt: epoch2time(x.epoch), data: x.data } })
    }

  </script>
</body>

</html>